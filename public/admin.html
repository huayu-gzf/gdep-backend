<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 迎新助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .input-group:focus-within i { color: #2563EB; transform: scale(1.1); }
        
        /* 结果提示浮窗 */
        .result-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-weight: 500;
            display: flex; align-items: center; gap: 10px;
            opacity: 0; transition: all 0.3s ease; pointer-events: none;
        }
        .result-toast.show { opacity: 1; top: 30px; }
        .toast-success { background: #ECFDF5; color: #059669; border: 1px solid #A7F3D0; }
        .toast-error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
        .toast-info { background: #EFF6FF; color: #2563EB; border: 1px solid #BFDBFE; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-indigo-100 to-purple-100 min-h-screen">

    <div id="result" class="result-toast"></div>

    <div class="min-h-screen flex flex-col items-center justify-center p-4">

        <div id="loginFormContainer" class="w-full max-w-md">
            <div class="glass-effect rounded-2xl shadow-xl overflow-hidden border border-white/50 p-8 relative">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-500 to-teal-600"></div>

                <div class="text-center mb-8 mt-2">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-50 text-green-600 rounded-full text-3xl mb-4 shadow-sm">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">系统后台管理</h1>
                    <p class="text-gray-500 text-sm mt-2">仅限授权人员访问</p>
                </div>

                <div class="space-y-5">
                    <div class="input-group relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none transition-transform duration-300">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <input type="text" id="admin-username" 
                            class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:bg-white transition-all" 
                            placeholder="管理员账号"
                            onkeyup="if(event.key === 'Enter') document.getElementById('admin-password').focus()">
                    </div>

                    <div class="input-group relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none transition-transform duration-300">
                            <i class="fas fa-key text-gray-400"></i>
                        </div>
                        <input type="password" id="admin-password" 
                            class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:bg-white transition-all" 
                            placeholder="管理员密码"
                            onkeyup="if(event.key === 'Enter') adminLogin()">
                    </div>

                    <button onclick="adminLogin()" 
                        class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-semibold py-3 rounded-lg hover:shadow-lg hover:translate-y-[-1px] transition-all flex items-center justify-center gap-2">
                        登录后台
                    </button>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between items-center">
                    <span class="text-xs text-gray-400">© 2024 GDEC Admin</span>
                    <a href="login.html" class="text-sm font-medium text-gray-600 hover:text-blue-600 flex items-center transition-colors">
                        <i class="fas fa-arrow-left mr-1 text-xs"></i>
                        返回普通用户登录
                    </a>
                </div>
            </div>
        </div>

        <div id="dashboardContainer" class="w-full max-w-7xl hidden">
            <div class="bg-white rounded-xl shadow-lg p-4 mb-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-gray-800">批量学生管理系统</h2>
                        <p class="text-xs text-gray-500">管理员模式</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                    <i class="fas fa-sign-out-alt mr-1"></i> 退出登录
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-file-alt text-blue-500 mr-2"></i> 文本批量添加
                    </h3>
                    <div class="bg-blue-50 text-blue-800 text-xs p-3 rounded mb-3 border-l-4 border-blue-500">
                        格式：学号,姓名,专业 (一行一个)
                    </div>
                    <textarea id="studentList" class="w-full h-40 p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none mb-3" placeholder="2024001,张三,计算机科学&#10;2024002,李四,软件工程"></textarea>
                    <button onclick="batchCreateStudents()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-plus-circle mr-1"></i> 开始批量添加
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-file-excel text-green-500 mr-2"></i> Excel 导入
                    </h3>
                    <div class="bg-green-50 text-green-800 text-xs p-3 rounded mb-3 border-l-4 border-green-500">
                        需包含列头：username, name, major
                    </div>
                    <label class="border-2 border-dashed border-gray-300 rounded-lg h-40 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors group mb-3">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 group-hover:text-green-500 mb-2"></i>
                        <span class="text-sm text-gray-500">点击上传 Excel 文件</span>
                        <span id="fileName" class="text-xs text-gray-400 mt-1">支持 .xlsx, .xls</span>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden">
                    </label>
                    <button id="uploadBtn" onclick="uploadExcel()" disabled class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-upload mr-1"></i> 上传并处理
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 flex items-center">
                        <i class="fas fa-list text-purple-500 mr-2"></i> 学生数据库
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="getStudentList()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i> 刷新
                        </button>
                        <button onclick="showAddStudentForm()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg text-sm transition-colors">
                            <i class="fas fa-plus mr-1"></i> 单个添加
                        </button>
                    </div>
                </div>

                <div id="studentForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <div class="flex justify-between mb-3">
                        <h4 id="formTitle" class="font-bold text-sm">编辑信息</h4>
                        <button onclick="cancelStudentForm()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-3">
                        <input id="studentUsername" type="text" placeholder="学号" class="p-2 border rounded text-sm">
                        <input id="studentName" type="text" placeholder="姓名" class="p-2 border rounded text-sm">
                        <input id="studentMajor" type="text" placeholder="专业" class="p-2 border rounded text-sm">
                        <input id="studentPassword" type="password" placeholder="密码(选填)" class="p-2 border rounded text-sm">
                    </div>
                    <button onclick="saveStudent()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm">保存提交</button>
                </div>

                <div id="batchDeleteControls" class="hidden bg-red-50 p-2 rounded mb-3 flex justify-between items-center">
                    <span id="selectedCount" class="text-xs text-red-600 font-medium ml-2">已选 0 人</span>
                    <button id="batchDeleteBtn" onclick="batchDeleteStudents()" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">删除选中</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-3 w-10"><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()"></th>
                                <th class="p-3">学号</th>
                                <th class="p-3">姓名</th>
                                <th class="p-3">专业</th>
                                <th class="p-3 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="noStudentsMessage" class="text-center py-8 text-gray-400 text-sm">
                        暂无数据，请先添加学生
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================== 核心逻辑与安全控制 ==================

        window.addEventListener('load', () => {
            const token = localStorage.getItem('adminToken');
            if (token) {
                switchView('dashboard');
                // 页面加载时立即验证Token有效性
                getStudentList().catch(err => {
                    console.error("初始化验证失败:", err);
                });
            } else {
                switchView('login');
            }
        });

        function switchView(viewName) {
            const loginContainer = document.getElementById('loginFormContainer');
            const dashboardContainer = document.getElementById('dashboardContainer');
            
            if (viewName === 'dashboard') {
                loginContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                document.body.classList.remove('items-center', 'justify-center'); 
                document.body.classList.add('items-start');
            } else {
                loginContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                document.body.classList.remove('items-start');
                document.body.classList.add('items-center', 'justify-center');
            }
        }

        // 统一鉴权拦截器
        async function checkAuth(res) {
            if (res.status === 401 || res.status === 403) {
                localStorage.removeItem('adminToken');
                switchView('login');
                showResult('登录已过期或无权限，请重新登录', 'error');
                throw new Error('Authentication failed');
            }
            return res;
        }

        function showResult(message, type = 'info') {
            const el = document.getElementById('result');
            el.className = ''; 
            void el.offsetWidth; // 触发重绘
            el.className = `result-toast show toast-${type}`;
            const icon = type === 'success' ? 'fa-check' : type === 'error' ? 'fa-times' : 'fa-info';
            el.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // ================== 业务功能逻辑 (使用相对路径) ==================

        async function adminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            
            if (!username || !password) return showResult('请输入完整信息', 'error');

            try {
                // 【修改点】相对路径
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                
                if (!res.ok || (data.user && data.user.role !== 'admin')) {
                    throw new Error(data.message || '登录失败或权限不足');
                }
                
                localStorage.setItem('adminToken', data.token);
                showResult('登录成功，欢迎回来', 'success');
                switchView('dashboard');
                getStudentList();
            } catch (err) {
                showResult(err.message, 'error');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            switchView('login');
            showResult('已退出登录', 'info');
            document.getElementById('studentTableBody').innerHTML = '';
            document.getElementById('studentList').value = '';
        }

        async function getStudentList() {
            const token = localStorage.getItem('adminToken');
            try {
                // 【修改点】相对路径
                const res = await fetch('/api/admin/students', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                await checkAuth(res);

                const data = await res.json();
                displayStudentList(data.data || []);
            } catch(e) { 
                if(e.message !== 'Authentication failed') console.error(e);
            }
        }

        function displayStudentList(students) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            if(!students.length) {
                document.getElementById('noStudentsMessage').style.display = 'block';
                return;
            }
            document.getElementById('noStudentsMessage').style.display = 'none';

            students.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-0';
                tr.innerHTML = `
                    <td class="p-3"><input type="checkbox" class="student-checkbox rounded text-blue-600 focus:ring-blue-500" value="${s._id}" onchange="updateSelectedCount()"></td>
                    <td class="p-3 font-mono text-gray-600">${s.username}</td>
                    <td class="p-3 font-medium text-gray-800">${s.name}</td>
                    <td class="p-3 text-gray-500">${s.major}</td>
                    <td class="p-3 text-right space-x-2">
                        <button onclick="editStudent('${s._id}', '${s.username}', '${s.name}', '${s.major}')" class="text-blue-500 hover:text-blue-700 transition-colors"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteStudent('${s._id}')" class="text-red-500 hover:text-red-700 transition-colors"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateSelectedCount();
        }

        async function batchCreateStudents() {
            const token = localStorage.getItem('adminToken');
            const text = document.getElementById('studentList').value;
            if(!text.trim()) return showResult('请输入学生信息', 'error');

            const lines = text.trim().split('\n');
            const students = lines.map(line => {
                const p = line.split(/,|，/); 
                return p.length >= 3 ? { username: p[0].trim(), name: p[1].trim(), major: p[2].trim() } : null;
            }).filter(i => i);

            if(students.length === 0) return showResult('格式错误，请检查输入', 'error');

            try {
                showResult('正在处理...', 'info');
                // 【修改点】相对路径
                const res = await fetch('/api/admin/batchCreateStudents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ students })
                });
                
                await checkAuth(res);
                const data = await res.json();
                if(res.ok) {
                    showResult(`添加完成。成功: ${data.data?.successCount || 0}，失败: ${data.data?.failCount || 0}`, 'success');
                    document.getElementById('studentList').value = '';
                    getStudentList();
                } else {
                    throw new Error(data.message);
                }
            } catch(e) { if(e.message !== 'Authentication failed') showResult(e.message, 'error'); }
        }

        async function uploadExcel() {
            const token = localStorage.getItem('adminToken');
            const file = document.getElementById('excelFile').files[0];
            if(!file) return;

            const formData = new FormData();
            formData.append('excelFile', file);

            try {
                showResult('文件上传中...', 'info');
                // 【修改点】相对路径
                const res = await fetch('/api/admin/uploadExcel', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                await checkAuth(res);
                const data = await res.json();
                if(res.ok) {
                    showResult(`导入成功: ${data.successCount} 人`, 'success');
                    getStudentList();
                } else {
                    throw new Error(data.message);
                }
            } catch(e) { if(e.message !== 'Authentication failed') showResult('上传失败: ' + e.message, 'error'); }
        }

        document.getElementById('excelFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || '未选择文件';
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('uploadBtn').disabled = !e.target.files[0];
        });

        let currentEditingStudentId = null;

        function showAddStudentForm() {
            document.getElementById('studentForm').classList.remove('hidden');
            document.getElementById('formTitle').textContent = '添加新学生';
            document.getElementById('studentUsername').value = '';
            document.getElementById('studentUsername').disabled = false;
            document.getElementById('studentName').value = '';
            document.getElementById('studentMajor').value = '';
            document.getElementById('studentPassword').value = '';
            currentEditingStudentId = null;
        }

        function cancelStudentForm() {
            document.getElementById('studentForm').classList.add('hidden');
        }

        function editStudent(id, user, name, major) {
            showAddStudentForm();
            document.getElementById('formTitle').textContent = '编辑学生';
            document.getElementById('studentUsername').value = user;
            document.getElementById('studentUsername').disabled = true;
            document.getElementById('studentName').value = name;
            document.getElementById('studentMajor').value = major;
            currentEditingStudentId = id;
        }

        async function saveStudent() {
            const token = localStorage.getItem('adminToken');
            const data = {
                username: document.getElementById('studentUsername').value,
                name: document.getElementById('studentName').value,
                major: document.getElementById('studentMajor').value,
                password: document.getElementById('studentPassword').value
            };
            
            if(!data.password) delete data.password;

            // 【修改点】相对路径
            const url = currentEditingStudentId 
                ? `/api/admin/students/${currentEditingStudentId}`
                : '/api/admin/students';
            
            const method = currentEditingStudentId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                
                await checkAuth(res);
                const json = await res.json();
                if(json.success) {
                    showResult('保存成功', 'success');
                    cancelStudentForm();
                    getStudentList();
                } else {
                    showResult(json.message, 'error');
                }
            } catch(e) { if(e.message !== 'Authentication failed') showResult('保存失败', 'error'); }
        }

        async function deleteStudent(id) {
            if(!confirm('确认删除该学生?')) return;
            const token = localStorage.getItem('adminToken');
            try {
                // 【修改点】相对路径
                const res = await fetch(`/api/admin/students/${id}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                await checkAuth(res);
                showResult('删除成功', 'success');
                getStudentList();
            } catch(e) { if(e.message !== 'Authentication failed') showResult('删除失败', 'error'); }
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.student-checkbox').forEach(c => c.checked = checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('.student-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = `已选 ${count} 人`;
            const div = document.getElementById('batchDeleteControls');
            if(count > 0) div.classList.remove('hidden');
            else div.classList.add('hidden');
        }

        async function batchDeleteStudents() {
            const ids = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(c => c.value);
            if(!confirm(`确认永久删除选中的 ${ids.length} 名学生?`)) return;
            
            const token = localStorage.getItem('adminToken');
            try {
                // 【修改点】相对路径
                const res = await fetch('/api/admin/students/batch', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ studentIds: ids })
                });
                
                await checkAuth(res);
                const json = await res.json();
                if(json.success) {
                    showResult(`批量删除成功: ${json.data.deletedCount} 人`, 'success');
                    getStudentList();
                }
            } catch(e) { if(e.message !== 'Authentication failed') showResult('批量删除失败', 'error'); }
        }
    </script>
</body>
</html>
